name: Zeabur è¿é€šåå¼€å…³æœºå¾ªç¯ (v3.1.0)

on:
  schedule:
    - cron: '*/20 * * * *'  # æ¯ 20 åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  suspend-and-restart:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹ç½‘é¡µè¿é€šæ€§
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ£€æµ‹ $TARGET æ˜¯å¦åœ¨çº¿..."
          
          # è·å– HTTP çŠ¶æ€ç 
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… ç½‘é¡µæ­£å¸¸å¼€å¯ï¼Œå‡†å¤‡æ‰§è¡Œ [å…³æœº -> 1åˆ†é’Ÿ -> é‡å¯] æµç¨‹..."
            echo "need_action=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ç½‘é¡µå½“å‰ä¸å¯è®¿é—® (çŠ¶æ€ç : $HTTP_STATUS)ï¼Œè·³è¿‡æœ¬æ¬¡æµç¨‹ã€‚"
            echo "need_action=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œå¼€å…³æœºæ“ä½œ (v2.9.0 æ–¹æ¡ˆ)
        if: steps.check_status.outputs.need_action == 'true'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. æ‰§è¡Œå…³æœºæŒ‡ä»¤ (Suspend)
          echo "Step 1: ğŸš€ æ­£åœ¨å‘é€ suspendService æŒ‡ä»¤..."
          SUSPEND_QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          SUSPEND_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$SUSPEND_QUERY" '{"query": $q}')")
          echo "API å“åº”: $SUSPEND_RES"

          # 2. ç­‰å¾… 1 åˆ†é’Ÿ
          echo "Step 2: â³ æ­£åœ¨ç­‰å¾… 1 åˆ†é’Ÿ (å†·å´ä¸­)..."
          sleep 60

          # 3. æ‰§è¡Œé‡å¯æŒ‡ä»¤ (ä½¿ç”¨ v2.9.0 çš„ restartService æ–¹æ¡ˆ)
          echo "Step 3: ğŸš€ æ­£åœ¨å‘é€ restartService æŒ‡ä»¤..."
          RESTART_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          RESTART_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$RESTART_QUERY" '{"query": $q}')")
          
          echo "API å“åº”: $RESTART_RES"
          
          if [[ $RESTART_RES == *"restartService\":true"* ]]; then
            echo "ğŸ‰ æµç¨‹æˆåŠŸç»“æŸï¼šå·²å®Œæˆå…³æœºå¹¶ä¸‹è¾¾é‡å¯æŒ‡ä»¤ã€‚"
          else
            echo "âŒ é‡å¯æŒ‡ä»¤ä¸‹è¾¾å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API å“åº”å†…å®¹ã€‚"
          fi
