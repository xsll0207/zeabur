name: Zeabur è¿é€šå³é‡å¯ (v2.8.1)

on:
  schedule:
    - cron: '*/20 * * * *'  # æ¯ 20 åˆ†é’Ÿè‡ªåŠ¨æ£€æµ‹
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-and-restart:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹ç½‘é¡µè¿é€šæ€§
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ£€æµ‹ $TARGET æ˜¯å¦åœ¨çº¿..."
          
          # è·å– HTTP çŠ¶æ€ç ï¼Œè¶…æ—¶è®¾ä¸º 15 ç§’
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… ç½‘é¡µæ­£å¸¸å¼€å¯ï¼Œå‡†å¤‡æ‰§è¡Œé‡å¯..."
            echo "need_restart=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ç½‘é¡µå½“å‰ä¸å¯è®¿é—®æˆ–å¼‚å¸¸ï¼Œè·³è¿‡æœ¬æ¬¡é‡å¯ã€‚"
            echo "need_restart=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œ v2.5.2 æ·±åº¦é‡å¯æ–¹æ¡ˆ
        if: steps.check_status.outputs.need_restart == 'true'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. å‘é€é‡å¯æŒ‡ä»¤
          echo "ğŸš€ å‘é€ restartService æŒ‡ä»¤..."
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          WAKE_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')")
          
          echo "API æŒ‡ä»¤å“åº”: $WAKE_RES"
          
          # 2. ç­‰å¾…ç³»ç»Ÿç ´å†°
          echo "â³ ç­‰å¾… 10 ç§’è®©ç³»ç»Ÿå¤„ç†è¯·æ±‚..."
          sleep 10

          # 3. é«˜é¢‘æ¢æµ‹å®¹å™¨çŠ¶æ€
          echo "ğŸ” æ­£åœ¨ç¡®è®¤é‡å¯çŠ¶æ€..."
          for i in {1..20}; do
            # ä½¿ç”¨ v2.5.2 æ¨èçš„ status(environmentID) è·¯å¾„ï¼Œé¿å… null æŠ¥é”™
            QUERY="query { service(_id: \"$SERVICE_ID\") { status(environmentID: \"$ENVIRONMENT_ID\") } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.status // "STARTING"')
            echo "â±ï¸ å®¹å™¨å½“å‰çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²æˆåŠŸé‡å¯å¹¶æ¢å¤è¿è¡Œï¼"
              exit 0
            elif [ "$STATUS" == "CRASHED" ]; then
              echo "âŒ é‡å¯åæœåŠ¡å´©æºƒï¼Œè¯·æ£€æŸ¥ Zeabur æ—¥å¿—ã€‚"
              exit 1
            fi
            sleep 5
          done
