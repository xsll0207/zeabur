name: Zeabur å…¨è‡ªåŠ¨å¯åŠ¨ä¸æ’é˜Ÿè¿½è¸ª (v2.5.0)

on:
  schedule:
    - cron: '*/20 * * * *' # æ¯20åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥å¹¶å°è¯•æ‹‰èµ·
  workflow_dispatch: # ä¹Ÿæ”¯æŒæ‰‹åŠ¨ä¸€é”®æµ‹è¯•

jobs:
  auto-wake-and-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: å¼ºåˆ¶å”¤é†’æœåŠ¡
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "ğŸš€ æ­£åœ¨å°è¯•å…¨è‡ªåŠ¨å”¤é†’æœåŠ¡..."
          
          # ç¬¬ä¸€æ­¥ï¼šå‘é€ restartService æŒ‡ä»¤ï¼ˆè¿™æ˜¯å”¤é†’ Suspended æœ€æœ‰æ•ˆçš„æŒ‡ä»¤ï¼‰
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          WAKE_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')")
          
          echo "å”¤é†’æŒ‡ä»¤å“åº”: $WAKE_RES"
          
          # ç­‰å¾… 5 ç§’ï¼Œç¡®ä¿ Zeabur åç«¯ç”Ÿæˆäº†æ–°çš„éƒ¨ç½²å®ä¾‹
          sleep 5

      - name: é”å®šéƒ¨ç½² ID å¹¶è®¡ç®—æ’é˜Ÿè€—æ—¶
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          # ç¬¬äºŒæ­¥ï¼šè·å–åˆšç”Ÿæˆçš„ Deployment ID
          LIST_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { _id status } } } } }"
          LIST_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$LIST_QUERY" '{"query": $q}')")
          
          DEPLOY_ID=$(echo $LIST_RES | jq -r '.data.service.deployments.edges[0].node._id')
          
          if [ "$DEPLOY_ID" == "null" ]; then
            echo "âŒ æ— æ³•é”å®šéƒ¨ç½² IDï¼Œå¯èƒ½å”¤é†’æŒ‡ä»¤æœªç”Ÿæ•ˆã€‚"
            exit 1
          fi
          
          echo "ğŸ¯ å·²é”å®šæ–°éƒ¨ç½²è®°å½•: $DEPLOY_ID"
          START_TIME=$(date +%s)
          
          # ç¬¬ä¸‰æ­¥ï¼šé«˜é¢‘æ¢æµ‹çŠ¶æ€å˜åŒ– (æ¯ 3 ç§’ä¸€æ¬¡)
          echo "â³ æ­£åœ¨å®æ—¶ç›‘æµ‹æ’é˜Ÿè¿›åº¦..."
          for i in {1..100}; do
            CHECK_QUERY="query { node(id: \"$DEPLOY_ID\") { ... on Deployment { status } } }"
            CHECK_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$CHECK_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $CHECK_RES | jq -r '.data.node.status')
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            
            echo "â±ï¸ [+$ELAPSED ç§’] çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²æˆåŠŸè¿è¡Œï¼"
              echo "ğŸ“Š æœ¬æ¬¡å¼€æœºæ’é˜Ÿæ€»è€—æ—¶: $ELAPSED ç§’"
              exit 0
            elif [ "$STATUS" == "QUEUING" ]; then
              echo "ğŸƒ å®¹å™¨æ­£åœ¨æ’é˜Ÿä¸­..."
            elif [ "$STATUS" == "INITIALIZING" ]; then
              echo "ğŸ› ï¸ å®¹å™¨æ­£åœ¨åˆå§‹åŒ–..."
            fi
            
            sleep 3
          done
