name: Zeabur å¯åŠ¨æ’é˜Ÿè¿½è¸ªå™¨ (v2.4.0)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        default: 'redeploy'
        type: choice
        options: [redeploy, restart]

jobs:
  track-startup:
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘å”¤é†’å¹¶é”å®šéƒ¨ç½²
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'redeploy' }}"
          
          # 1. å‘é€å”¤é†’æŒ‡ä»¤
          echo "ğŸš€ æ­£åœ¨å‘é€ ${ACTION} æŒ‡ä»¤..."
          curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { ${ACTION}Service(serviceID: \\\"$SERVICE_ID\\\", environmentID: \\\"$ENVIRONMENT_ID\\\") }\"}"

          # 2. ç¨ç­‰ 3 ç§’è®©ç³»ç»Ÿç”Ÿæˆæ–°éƒ¨ç½² ID
          sleep 3

          # 3. é”å®šæœ€æ–°çš„éƒ¨ç½²è®°å½• ID
          QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { _id status } } } } }"
          RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          DEPLOY_ID=$(echo $RES | jq -r '.data.service.deployments.edges[0].node._id')
          
          echo "ğŸ¯ å·²é”å®šæœ¬æ¬¡å¯åŠ¨çš„éƒ¨ç½² ID: $DEPLOY_ID"

          # 4. å¼€å§‹é«˜é¢‘è®¡æ—¶æ¢æµ‹
          START_TIME=$(date +%s)
          echo "â³ æ­£åœ¨å®æ—¶è¿½è¸ªçŠ¶æ€å˜åŒ–..."
          
          for i in {1..60}; do
            # æŸ¥è¯¢è¯¥ç‰¹å®šéƒ¨ç½²çš„å®æ—¶çŠ¶æ€
            CHECK_QUERY="query { node(id: \"$DEPLOY_ID\") { ... on Deployment { status } } }"
            CHECK_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$CHECK_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $CHECK_RES | jq -r '.data.node.status // "UNKNOWN"')
            ELAPSED=$(($(date +%s) - START_TIME))
            
            echo "â±ï¸ [+$ELAPSED ç§’] éƒ¨ç½²çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… å¼€æœºæˆåŠŸï¼æ€»è€—æ—¶: $ELAPSED ç§’"
              exit 0
            elif [ "$STATUS" == "QUEUING" ] || [ "$STATUS" == "INITIALIZING" ]; then
              echo "ğŸƒ å‘ç°æ’é˜Ÿ/åˆå§‹åŒ–ä¿¡å·..."
            fi
            sleep 4 # é«˜é¢‘æ¢æµ‹
          done
