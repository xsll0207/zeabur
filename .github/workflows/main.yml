name: Zeabur çŠ¶æ€è‡ªåŠ¨ç¿»è½¬

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  toggle-service:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹å½“å‰è¿é€šæ€§
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ¢æµ‹ $TARGET ..."
          
          # è·å– HTTP çŠ¶æ€ç 
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… æœåŠ¡åœ¨çº¿ï¼Œå‡†å¤‡ [å…³æœº]ã€‚"
            echo "action=suspend" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœåŠ¡ç¦»çº¿ï¼Œå‡†å¤‡ [é‡å¯/å¼€æœº]ã€‚"
            echo "action=restart" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡ŒçŠ¶æ€åˆ‡æ¢
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION_TYPE="${{ steps.check_status.outputs.action }}"
          
          if [ "$ACTION_TYPE" == "suspend" ]; then
            echo "ğŸš€ å‘é€ suspendService æŒ‡ä»¤..."
            QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          else
            echo "ğŸš€ å‘é€ restartService æŒ‡ä»¤..."
            QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          fi

          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API å“åº”: $RESPONSE"
          echo "ğŸ‰ æŒ‡ä»¤å·²æˆåŠŸä¸‹è¾¾ã€‚"
