name: Zeabur å…¨è‡ªåŠ¨ç›‘æ§ (v2.5.1)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  auto-wake:
    runs-on: ubuntu-latest
    steps:
      - name: å”¤é†’å¹¶æ·±åº¦æ¢æµ‹
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. å‘é€é‡å¯æŒ‡ä»¤
          echo "ğŸš€ å‘é€ restartService æŒ‡ä»¤..."
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')"
          
          echo "â³ ç­‰å¾…ç³»ç»Ÿå“åº”..."
          sleep 8

          # 2. å°è¯•é”å®š Deployment IDï¼Œå¦‚æœé”ä¸åˆ°å°±ç›´æ¥æŸ¥ Service çŠ¶æ€
          LIST_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { _id } } } } }"
          LIST_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$LIST_QUERY" '{"query": $q}')")
          DEPLOY_ID=$(echo $LIST_RES | jq -r '.data.service.deployments.edges[0].node._id // ""')

          START_TIME=$(date +%s)
          echo "ç›‘æ§å¼€å§‹..."

          for i in {1..50}; do
            # å¦‚æœæœ‰éƒ¨ç½² ID åˆ™æŸ¥éƒ¨ç½²ï¼Œå¦åˆ™æŸ¥æœåŠ¡çŠ¶æ€æœº
            if [ -n "$DEPLOY_ID" ] && [ "$DEPLOY_ID" != "null" ]; then
              QUERY="query { node(id: \"$DEPLOY_ID\") { ... on Deployment { status } } }"
              RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
              STATUS=$(echo $RES | jq -r '.data.node.status')
            else
              QUERY="query { service(_id: \"$SERVICE_ID\") { state(environmentID: \"$ENVIRONMENT_ID\") { status } } }"
              RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
              STATUS=$(echo $RES | jq -r '.data.service.state.status')
            fi

            ELAPSED=$(($(date +%s) - START_TIME))
            echo "â±ï¸ [+$ELAPSED s] çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
              echo "ğŸ“Š è¯†åˆ«åˆ°å¼€æœºæ€»è€—æ—¶: $ELAPSED ç§’"
              exit 0
            fi
            sleep 5
          done
