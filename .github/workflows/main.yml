name: Zeabur ç»ˆæç›‘æµ‹ä¸å”¤é†’ (v2.2.0)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        default: 'redeploy'
        type: choice
        options: [redeploy, restart, suspend]

jobs:
  zeabur-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: å¼ºåˆ¶æ‹‰èµ·æœåŠ¡
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'redeploy' }}"
          echo "ğŸš€ å°è¯•é€šè¿‡ ${ACTION} æŒ‡ä»¤å”¤é†’æœåŠ¡..."

          # é’ˆå¯¹ Suspended çŠ¶æ€ï¼Œå°è¯•æœ€å®Œæ•´çš„å‚æ•°ç»„åˆ
          QUERY="mutation { ${ACTION}Service(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API æŒ‡ä»¤å“åº”: $RESPONSE"

      - name: æ•è·æ’é˜Ÿä¸å¯åŠ¨è€—æ—¶
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "â³ æ­£åœ¨å®æ—¶è¿½è¸ªå®¹å™¨çŠ¶æ€æœº..."
          START_TIME=$(date +%s)
          
          # å¢åŠ æ¢æµ‹é¢‘ç‡è‡³ 5 ç§’ä¸€æ¬¡ï¼Œä»¥é˜²é”™è¿‡â€œæ’é˜Ÿâ€çŠ¶æ€
          for i in {1..60}; do
            sleep 5
            
            # ä½¿ç”¨ zeabur-monitor é¡¹ç›®æ¨èçš„ state æŸ¥è¯¢è·¯å¾„
            # è¿™æ˜¯è·å–â€œæ’é˜Ÿâ€çŠ¶æ€æœ€çµæ•çš„èŠ‚ç‚¹
            STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { state(environmentID: \"$ENVIRONMENT_ID\") { status } } }"
            
            RES=$(curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.state.status // "INACTIVE"')
            ELAPSED=$(($(date +%s) - START_TIME))
            
            echo "â±ï¸ [+$ELAPSEDs] å®æ—¶çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              echo "ğŸ“Š æ€»æ’é˜Ÿè€—æ—¶: $ELAPSED ç§’"
              exit 0
            elif [[ "$STATUS" == "QUEUING" || "$STATUS" == "INITIALIZING" || "$STATUS" == "STARTING" ]]; then
              echo "ğŸƒ å‘ç°å®¹å™¨æ’é˜Ÿ/åˆå§‹åŒ–ä¿¡å·..."
            fi
          done
          
          echo "âš ï¸ è­¦å‘Šï¼šå®¹å™¨ä»å¤„äº $STATUS çŠ¶æ€ï¼Œæœªèƒ½æˆåŠŸæ‹‰èµ·ã€‚è¯·æ£€æŸ¥ Zeabur é¢åº¦æ˜¯å¦å·²ç”¨å®Œã€‚"
