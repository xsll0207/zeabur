name: Zeabur 自动化控制 (v1.6.2)

on:
  schedule:
    - cron: '*/20 * * * *'  # 每 20 分钟自动关机
  workflow_dispatch:
    inputs:
      action:
        description: '执行动作'
        required: true
        default: 'suspend'
        type: choice
        options: [suspend, resume]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: 执行控制指令
        run: |
          ACTION="${{ github.event.inputs.action || 'suspend' }}"
          
          # 直接读取 Secrets
          S_ID="${{ secrets.SERVICE_ID }}"
          E_ID="${{ secrets.ENVIRONMENT_ID }}"

          echo "正在对服务 $S_ID (环境 $E_ID) 执行 $ACTION 操作..."

          # 使用标准 GraphQL Mutation 格式
          QUERY="mutation { ${ACTION}Service(serviceID: \"$S_ID\", environmentID: \"$E_ID\") }"
          
          RESPONSE=$(curl -s --request POST \
            --url https://api.zeabur.com/graphql \
            --header "Authorization: Bearer ${{ secrets.ZEABUR_TOKEN }}" \
            --header "Content-Type: application/json" \
            --data "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API 响应内容: $RESPONSE"

          # 判定逻辑
          if [[ $RESPONSE == *"\"${ACTION}Service\":true"* ]]; then
            echo "✅ 指令执行成功！服务已尝试 $ACTION"
          elif [[ $RESPONSE == *"Permission denied"* ]]; then
            echo "❌ 权限拒绝：请确认您的 Token 是否包含该项目权限"
            exit 1
          else
            echo "❌ 执行异常，请检查响应内容"
            exit 1
          fi
