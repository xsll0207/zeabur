name: Zeabur å¼ºåŠ›é‡å¯ (v1.9.5)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        required: true
        default: 'redeploy'
        type: choice
        options: [redeploy, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘é‡å¯æŒ‡ä»¤
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'redeploy' }}"
          
          # æ¨¡æ‹Ÿç½‘é¡µâ€œé‡å¯å½“å‰ç‰ˆæœ¬â€æŒ‰é’®
          # å°è¯•åªä¼  serviceIDï¼Œè¿™é€šå¸¸ä¼šè§¦å‘å½“å‰ç¯å¢ƒçš„é‡æ–°éƒ¨ç½²
          QUERY="mutation { redeployService(serviceID: \"$SERVICE_ID\") }"
          
          if [ "$ACTION" == "suspend" ]; then
            QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"${{ secrets.ENVIRONMENT_ID }}\") }"
          fi

          echo "ğŸš€ æ­£åœ¨å‘é€ $ACTION æŒ‡ä»¤..."
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API å“åº”: $RESPONSE"

      - name: å®æ—¶è®¡ç®—æ’é˜Ÿä¸å¯åŠ¨æ—¶é—´
        if: github.event.inputs.action == 'redeploy'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "â³ æ­£åœ¨ç›‘æ§å®¹å™¨æ‹‰èµ·è¿›åº¦..."
          START_TIME=$(date +%s)
          
          # å¢åŠ æ£€æŸ¥é¢‘ç‡ï¼ˆæ¯10ç§’ä¸€æ¬¡ï¼‰ä»¥æ•æ‰æ’é˜Ÿç¬é—´
          for i in {1..60}; do
            sleep 10
            
            # æŸ¥è¯¢æœ€æ–°éƒ¨ç½²çŠ¶æ€
            QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.deployments.edges[0].node.status // "UNKNOWN"')
            ELAPSED=$(($(date +%s) - START_TIME))
            
            echo "â±ï¸ [+$ELAPSEDç§’] å®¹å™¨çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ªï¼æ€»æ’é˜Ÿå¯åŠ¨è€—æ—¶: $ELAPSED ç§’"
              exit 0
            elif [[ "$STATUS" == "QUEUING" || "$STATUS" == "INITIALIZING" || "$STATUS" == "PREPARING" ]]; then
              echo "ğŸƒ æ­£åœ¨æ’é˜Ÿ/åˆå§‹åŒ–ä¸­..."
            fi
          done
          echo "âš ï¸ å¯åŠ¨æ—¶é—´è¿‡é•¿ï¼Œè¯·æ£€æŸ¥ç½‘é¡µç«¯æ˜¯å¦æœ‰æŠ¥é”™ã€‚"
