name: Zeabur 状态唤醒与排队监测 (v1.9.4)

on:
  workflow_dispatch:
    inputs:
      action:
        description: '执行动作'
        required: true
        default: 'resume'
        type: choice
        options: [resume, redeploy, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: 唤醒服务
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'resume' }}"
          
          if [ "$ACTION" == "resume" ]; then
            echo "尝试唤醒 Suspended 服务..."
            # 尝试方案 A: 标准的 resumeService (带环境ID)
            QUERY="mutation { resumeService(_id: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
            echo "方案 A 响应: $RES"
            
            if [[ $RES == *"errors"* ]]; then
              echo "方案 A 不适用，尝试方案 B: redeployService..."
              QUERY_B="mutation { redeployService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
              RES_B=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY_B" '{"query": $q}')")
              echo "方案 B 响应: $RES_B"
            fi
          else
            QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
            curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')"
          fi

      - name: 深度监控状态
        if: github.event.inputs.action != 'suspend'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "⏳ 正在检测容器实时状态..."
          for i in {1..30}; do
            sleep 15
            # 换一种查询路径：通过 deployments 抓取最新的实时状态
            QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.deployments.edges[0].node.status // "INACTIVE"')
            echo "⏱️ [$(date +%T)] 状态: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "✅ 服务已运行！"
              exit 0
            elif [ "$STATUS" == "QUEUING" ] || [ "$STATUS" == "INITIALIZING" ]; then
              echo "ℹ️ 容器正在排队或初始化中..."
            fi
          done
