name: Zeabur è¿é€šåå¼€å…³æœºå¾ªç¯ (v3.0.0)

on:
  schedule:
    - cron: '*/20 * * * *'  # æ¯ 20 åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  suspend-and-wake:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹ç½‘é¡µè¿é€šæ€§
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ£€æµ‹ $TARGET æ˜¯å¦åœ¨çº¿..."
          
          # è·å– HTTP çŠ¶æ€ç 
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… ç½‘é¡µæ­£å¸¸å¼€å¯ï¼Œå‡†å¤‡æ‰§è¡Œ [å…³æœº -> 1åˆ†é’Ÿ -> å¼€æœº] æµç¨‹..."
            echo "need_action=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ç½‘é¡µå½“å‰ä¸å¯è®¿é—®ï¼Œè·³è¿‡æœ¬æ¬¡æµç¨‹ã€‚"
            echo "need_action=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œå¼€å…³æœºå¾ªç¯
        if: steps.check_status.outputs.need_action == 'true'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. æ‰§è¡Œå…³æœºæŒ‡ä»¤ (Suspend)
          echo "Step 1: ğŸš€ æ­£åœ¨å‘é€ suspendService æŒ‡ä»¤..."
          SUSPEND_QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          SUSPEND_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$SUSPEND_QUERY" '{"query": $q}')")
          echo "å…³æœºå“åº”: $SUSPEND_RES"

          # 2. ç­‰å¾… 1 åˆ†é’Ÿ
          echo "Step 2: â³ æ­£åœ¨ç­‰å¾… 1 åˆ†é’Ÿ (å†·å´ä¸­)..."
          sleep 60

          # 3. æ‰§è¡Œå¼€æœºæŒ‡ä»¤ (ä½¿ç”¨ v2.5.2 éªŒè¯è¿‡çš„ restartService æ–¹æ¡ˆ)
          echo "Step 3: ğŸš€ æ­£åœ¨å‘é€ restartService æŒ‡ä»¤å”¤é†’æœåŠ¡..."
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          WAKE_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')")
          echo "å¼€æœºå“åº”: $WAKE_RES"

          if [[ $WAKE_RES == *"restartService\":true"* ]]; then
            echo "ğŸ‰ æµç¨‹åœ†æ»¡å®Œæˆï¼šå·²æˆåŠŸå…³æœºå¹¶åœ¨1åˆ†é’Ÿåé‡æ–°å”¤é†’ã€‚"
          else
            echo "âš ï¸ å¼€æœºæŒ‡ä»¤å¯èƒ½æœªç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥ API å“åº”ã€‚"
          fi
