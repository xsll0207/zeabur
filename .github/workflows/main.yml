name: Zeabur å¼ºåˆ¶é‡å¯ä¸ç›‘æ§ (v1.9.2)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        required: true
        default: 'redeploy'
        type: choice
        options: [redeploy, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡ŒæŒ‡ä»¤
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'redeploy' }}"
          
          if [ "$ACTION" == "redeploy" ]; then
            # è¿™é‡Œçš„æŒ‡ä»¤å¯¹åº”ç½‘é¡µä¸Šçš„â€œé‡å¯å½“å‰ç‰ˆæœ¬â€
            QUERY="mutation { redeployService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          else
            QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          fi

          echo "ğŸš€ æ­£åœ¨å‘ Zeabur å‘é€ $ACTION æŒ‡ä»¤..."
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API å“åº”: $RESPONSE"

          if [[ $RESPONSE == *"redeployService\":true"* || $RESPONSE == *"suspendService\":true"* ]]; then
            echo "âœ… æŒ‡ä»¤å·²æˆåŠŸä¸‹è¾¾ï¼"
          else
            echo "âŒ æŒ‡ä»¤ä¸‹è¾¾å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
            # å¤‡ç”¨æ–¹æ¡ˆï¼šæœ‰äº›è´¦å·å¯èƒ½åªéœ€è¦ serviceID
            QUERY_ALT="mutation { redeployService(serviceID: \"$SERVICE_ID\") }"
            curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$QUERY_ALT" '{"query": $q}')"
          fi

      - name: ç›‘æ§æ’é˜Ÿä¸çŠ¶æ€
        if: github.event.inputs.action != 'suspend'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "â³ å¼€å§‹ç›‘æ§å®¹å™¨çŠ¶æ€..."
          for i in {1..30}; do
            sleep 15
            STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
            STATUS_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $STATUS_RES | jq -r '.data.service.deployments.edges[0].node.status // "UNKNOWN"')
            echo "â±ï¸ [$(date +%T)] å½“å‰å®¹å™¨çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "ğŸ‰ æœåŠ¡å·²å½»åº•å¯åŠ¨å¹¶æ¢å¤è®¿é—®ï¼"
              exit 0
            fi
          done
          echo "âš ï¸ çŠ¶æ€æ›´æ–°ç¼“æ…¢ï¼Œè¯·å»ç½‘é¡µç‰ˆç¡®è®¤ã€‚"
