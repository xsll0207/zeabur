name: Zeabur å»¶æ—¶åˆ·æ–°é‡å¯ (v2.9.0)

on:
  schedule:
    - cron: '*/20 * * * *'  # æ¯ 20 åˆ†é’Ÿè‡ªåŠ¨æ£€æµ‹
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-and-restart:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹ç½‘é¡µè¿é€šæ€§
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ£€æµ‹ $TARGET æ˜¯å¦åœ¨çº¿..."
          
          # è·å– HTTP çŠ¶æ€ç 
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… ç½‘é¡µæ­£å¸¸å¼€å¯ï¼Œå‡†å¤‡å»¶æ—¶é‡å¯..."
            echo "need_restart=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ç½‘é¡µå½“å‰æ— æ³•è®¿é—® (çŠ¶æ€ç : $HTTP_STATUS)ï¼Œè·³è¿‡æœ¬æ¬¡é‡å¯ã€‚"
            echo "need_restart=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œå»¶æ—¶é‡å¯
        if: steps.check_status.outputs.need_restart == 'true'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "â³ ç½‘é¡µå·²ç¡®è®¤æ­£å¸¸ï¼Œç­‰å¾… 30 ç§’åæ‰§è¡ŒæŒ‡ä»¤..."
          sleep 30

          # å‘é€ v2.5.2 æ ¸å¿ƒé‡å¯æŒ‡ä»¤
          echo "ğŸš€ æ­£åœ¨å‘é€ restartService æŒ‡ä»¤..."
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')")
          
          echo "API æŒ‡ä»¤å“åº”: $RESPONSE"
          
          if [[ $RESPONSE == *"restartService\":true"* ]]; then
            echo "ğŸ‰ é‡å¯æŒ‡ä»¤å·²æˆåŠŸä¸‹è¾¾ï¼Œæµç¨‹ç»“æŸã€‚"
          else
            echo "âŒ é‡å¯æŒ‡ä»¤å¯èƒ½æœªç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥å“åº”å†…å®¹ã€‚"
          fi
