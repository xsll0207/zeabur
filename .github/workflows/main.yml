name: Zeabur æ·±åº¦å”¤é†’ä¸æ’é˜Ÿç›‘æµ‹ (v2.0.0)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        required: true
        default: 'redeploy'
        type: choice
        options: [redeploy, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–æœ€æ–°éƒ¨ç½² ID å¹¶æ‰§è¡Œé‡å¯
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. è·å–æœ€åä¸€æ¬¡éƒ¨ç½²çš„ ID
          LIST_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { _id } } } } }"
          LIST_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$LIST_QUERY" '{"query": $q}')")
          
          DEPLOY_ID=$(echo $LIST_RES | jq -r '.data.service.deployments.edges[0].node._id')
          
          if [ "$DEPLOY_ID" == "null" ] || [ -z "$DEPLOY_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°éƒ¨ç½²è®°å½•ï¼Œå°è¯•æ™®é€šé‡å¯..."
            QUERY="mutation { redeployService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          else
            echo "ğŸ¯ æ‰¾åˆ°ç›®æ ‡éƒ¨ç½² ID: $DEPLOY_ID"
            # 2. æ¨¡ä»¿ç½‘é¡µç«¯ï¼šé’ˆå¯¹ç‰¹å®šéƒ¨ç½² ID è¿›è¡Œé‡éƒ¨ç½²
            QUERY="mutation { redeployService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\", deploymentID: \"$DEPLOY_ID\") }"
          fi

          echo "ğŸš€ å‘é€æŒ‡ä»¤..."
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          echo "API å“åº”: $RESPONSE"

      - name: ç›‘æµ‹æ’é˜Ÿè€—æ—¶
        if: github.event.inputs.action == 'redeploy'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "â³ ç›‘æµ‹å®¹å™¨æ‹‰èµ·çŠ¶æ€..."
          START_TIME=$(date +%s)
          for i in {1..60}; do
            sleep 10
            # è¿™é‡ŒæŸ¥è¯¢çš„æ˜¯ service çš„å®æ—¶è¿è¡ŒçŠ¶æ€
            STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.deployments.edges[0].node.status // "UNKNOWN"')
            ELAPSED=$(($(date +%s) - START_TIME))
            echo "â±ï¸ [+$ELAPSEDs] çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ªï¼æ€»æ’é˜Ÿå¯åŠ¨æ—¶é—´: $ELAPSED ç§’"
              exit 0
            fi
          done
