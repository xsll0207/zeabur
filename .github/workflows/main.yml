name: Zeabur 深度状态监控 (v1.9.3)

on:
  workflow_dispatch:
    inputs:
      action:
        description: '执行动作'
        required: true
        default: 'redeploy'
        type: choice
        options: [redeploy, suspend, restart]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: 执行控制指令
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'redeploy' }}"
          
          # 使用最直接的 Mutation
          QUERY="mutation { ${ACTION}Service(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API 指令响应: $RESPONSE"

      - name: 监控容器排队与运行
        if: github.event.inputs.action != 'suspend'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "⏳ 正在探测服务状态..."
          START_TIME=$(date +%s)
          
          for i in {1..30}; do
            sleep 15
            
            # 改进后的查询：直接获取服务在特定环境下的状态
            STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { state(environmentID: \"$ENVIRONMENT_ID\") { status } } }"
            
            STATUS_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
            
            # 解析 status (例如: RUNNING, STARTING, CRASHED)
            STATUS=$(echo $STATUS_RES | jq -r '.data.service.state.status // "UNKNOWN"')
            
            echo "⏱️ [$(date +%T)] 实时状态: $STATUS (累计等待 $(($(date +%s) - START_TIME)) 秒)"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "✅ 服务已完全恢复！排队耗时: $(($(date +%s) - START_TIME)) 秒"
              exit 0
            fi
            
            if [ "$STATUS" == "CRASHED" ]; then
              echo "❌ 服务启动失败并崩溃。"
              exit 1
            fi
          done
