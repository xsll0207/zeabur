name: Zeabur è‡ªåŠ¨å”¤é†’ä¸æ’é˜Ÿç›‘æµ‹ (v2.5.2)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  auto-wake:
    runs-on: ubuntu-latest
    steps:
      - name: å”¤é†’å¹¶æ·±åº¦æ¢æµ‹
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # 1. å‘é€é‡å¯æŒ‡ä»¤
          echo "ğŸš€ å‘é€ restartService æŒ‡ä»¤..."
          WAKE_QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$WAKE_QUERY" '{"query": $q}')"
          
          echo "â³ ç­‰å¾…ç³»ç»Ÿç ´å†°..."
          sleep 10

          START_TIME=$(date +%s)
          echo "ğŸ” æ­£åœ¨é«˜é¢‘æ¢æµ‹å®¹å™¨çŠ¶æ€æœº..."

          for i in {1..60}; do
            # ä¿®æ­£åçš„æŸ¥è¯¢ï¼šç›´æ¥æŸ¥ service èŠ‚ç‚¹ä¸‹çš„çŠ¶æ€ï¼Œé¿å… state èŠ‚ç‚¹è¿”å› null
            QUERY="query { service(_id: \"$SERVICE_ID\") { status(environmentID: \"$ENVIRONMENT_ID\") } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
            
            # æå–çŠ¶æ€ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼é˜²æ­¢ null
            STATUS=$(echo $RES | jq -r '.data.service.status // "STARTING"')
            
            ELAPSED=$(($(date +%s) - START_TIME))
            echo "â±ï¸ [+$ELAPSED s] å®¹å™¨çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²æ­£å¼è¿è¡Œï¼"
              echo "ğŸ“Š å¼€æœºæ’é˜Ÿæ€»è€—æ—¶: $ELAPSED ç§’"
              exit 0
            elif [ "$STATUS" == "CRASHED" ]; then
              echo "âŒ æœåŠ¡å¯åŠ¨å´©æºƒï¼Œè¯·æ£€æŸ¥ Zeabur æ§åˆ¶å°æ—¥å¿—ã€‚"
              exit 1
            fi
            sleep 5
          done
