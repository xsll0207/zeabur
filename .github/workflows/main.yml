name: Zeabur æ™ºèƒ½ç›‘æµ‹é‡å¯ (v2.1.0)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        default: 'restart'
        type: choice
        options: [restart, suspend]

jobs:
  monitor-and-restart:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡Œé‡å¯/å”¤é†’æŒ‡ä»¤
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'restart' }}"
          echo "ğŸš€ ç›®æ ‡æœåŠ¡: $SERVICE_ID"
          
          # æ¨¡ä»¿ zeabur-monitor çš„æ ¸å¿ƒæŒ‡ä»¤
          QUERY="mutation { ${ACTION}Service(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API æŒ‡ä»¤å“åº”: $RESPONSE"

      - name: å®æ—¶æ’é˜Ÿç›‘æµ‹
        if: github.event.inputs.action != 'suspend'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "â³ å¼€å§‹ç›‘æµ‹å®¹å™¨æ’é˜ŸçŠ¶æ€..."
          START_TIME=$(date +%s)
          
          # æ¨¡æ‹Ÿ monitor é¡¹ç›®çš„è½®è¯¢é€»è¾‘
          for i in {1..40}; do
            sleep 10
            
            # å‚è€ƒæŸ¥è¯¢è¯­æ³•ï¼šç›´æ¥è·å– service ä¸‹çš„ç¯å¢ƒçŠ¶æ€
            STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { state(environmentID: \"$ENVIRONMENT_ID\") { status } } }"
            RES=$(curl -s -X POST https://api.zeabur.com/graphql \
              -H "Authorization: Bearer $ZEABUR_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $RES | jq -r '.data.service.state.status // "UNKNOWN"')
            ELAPSED=$(($(date +%s) - START_TIME))
            
            echo "â±ï¸ [+$ELAPSEDs] å½“å‰çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… æœåŠ¡å·²æˆåŠŸæ‹‰èµ·ï¼"
              echo "ğŸ“Š æ’é˜Ÿè€—æ—¶ç»Ÿè®¡: $ELAPSED ç§’"
              exit 0
            elif [ "$STATUS" == "CRASHED" ]; then
              echo "âŒ æœåŠ¡å´©æºƒï¼Œè¯·æ£€æŸ¥ Zeabur æ—¥å¿—ã€‚"
              exit 1
            fi
          done
          echo "âš ï¸ ç›‘æµ‹è¶…æ—¶ï¼ŒæœåŠ¡å¯èƒ½ä»åœ¨æ’é˜Ÿæˆ–å¯åŠ¨è¾ƒæ…¢ã€‚"
