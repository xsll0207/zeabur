name: Zeabur æ‰‹åŠ¨å¯åŠ¨è€—æ—¶åˆ†æ (v2.3.0)

on:
  workflow_dispatch: # å»ºè®®ä½ ç‚¹å®Œç½‘é¡µæŒ‰é’®åï¼Œç«‹åˆ»æ‰‹åŠ¨è¿è¡Œè¿™ä¸ª Action

jobs:
  track-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: è¿½è¸ªæœ€æ–°éƒ¨ç½²è¿›åº¦
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "ğŸ” æ­£åœ¨æ£€ç´¢æœ€æ–°éƒ¨ç½²è®°å½•..."
          
          # è·å–æœ€æ–°ä¸€æ¡éƒ¨ç½²çš„ ID å’Œåˆå§‹çŠ¶æ€
          QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { _id status createdAt } } } } }"
          INIT_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          DEPLOY_ID=$(echo $INIT_RES | jq -r '.data.service.deployments.edges[0].node._id')
          CREATED_AT=$(echo $INIT_RES | jq -r '.data.service.deployments.edges[0].node.createdAt')
          
          echo "ğŸ“¡ å½“å‰æœ€æ–°éƒ¨ç½² ID: $DEPLOY_ID (åˆ›å»ºäº: $CREATED_AT)"
          
          START_TS=$(date +%s)
          
          for i in {1..100}; do
            # æŸ¥è¯¢è¯¥ç‰¹å®šéƒ¨ç½² ID çš„å®æ—¶çŠ¶æ€
            CHECK_QUERY="query { node(id: \"$DEPLOY_ID\") { ... on Deployment { status } } }"
            CHECK_RES=$(curl -s -X POST https://api.zeabur.com/graphql -H "Authorization: Bearer $ZEABUR_TOKEN" -H "Content-Type: application/json" -d "$(jq -n --arg q "$CHECK_QUERY" '{"query": $q}')")
            
            STATUS=$(echo $CHECK_RES | jq -r '.data.node.status')
            NOW_TS=$(date +%s)
            DIFF=$((NOW_TS - START_TS))
            
            echo "â±ï¸ [+$DIFF s] éƒ¨ç½²çŠ¶æ€: $STATUS"

            if [ "$STATUS" == "RUNNING" ]; then
              echo "âœ… å¯åŠ¨æˆåŠŸï¼"
              # è¿™é‡Œçš„è€—æ—¶æ˜¯è„šæœ¬ç›‘æµ‹åˆ°çš„è€—æ—¶ï¼Œå»ºè®®å¯¹æ¯”ç½‘é¡µä¸Šçš„éƒ¨ç½²æ—¶é—´æˆ³
              exit 0
            fi
            sleep 3
          done
