name: Zeabur æ™ºèƒ½æ§åˆ¶ (v1.9.1)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ (suspend/redeploy)'
        required: true
        default: 'redeploy'
        type: choice
        options: [redeploy, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡ŒæŒ‡ä»¤å¹¶ç›‘æ§çŠ¶æ€
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          # ä¿®æ­£åŠ¨ä½œï¼šå¦‚æœè¾“å…¥æ˜¯ resumeï¼Œè‡ªåŠ¨è½¬ä¸º redeploy
          RAW_ACTION="${{ github.event.inputs.action || 'suspend' }}"
          if [ "$RAW_ACTION" == "resume" ] || [ "$RAW_ACTION" == "redeploy" ]; then
            ACTION="redeploy"
          else
            ACTION="suspend"
          fi
          
          echo "ğŸš€ æ­£åœ¨æ‰§è¡Œæ“ä½œ: ${ACTION}Service"

          # 1. å‘é€æ§åˆ¶æŒ‡ä»¤
          # æ³¨æ„ï¼šredeployService é€šå¸¸åªéœ€è¦ serviceID 
          QUERY="mutation { ${ACTION}Service(serviceID: \"$SERVICE_ID\") }"
          
          # å¦‚æœæ˜¯ suspendï¼Œåˆ™éœ€è¦ environmentID
          if [ "$ACTION" == "suspend" ]; then
             QUERY="mutation { suspendService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          fi

          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API æŒ‡ä»¤å“åº”: $RESPONSE"

          # 2. å¦‚æœæ˜¯ redeploy (å¯åŠ¨)ï¼Œç›‘æ§æ’é˜Ÿæ—¶é—´
          if [ "$ACTION" == "redeploy" ]; then
            echo "â³ æ­£åœ¨æ£€æµ‹å¯åŠ¨æ’é˜Ÿè€—æ—¶..."
            START_TIME=$(date +%s)
            
            for i in {1..40}; do
              sleep 10
              
              # ä¿®æ­£åçš„çŠ¶æ€æŸ¥è¯¢è¯­å¥
              STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
              STATUS_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
                -H "Authorization: Bearer $ZEABUR_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
              
              # æå–çŠ¶æ€
              CURRENT_STATUS=$(echo $STATUS_RES | jq -r '.data.service.deployments.edges[0].node.status // "UNKNOWN"')
              
              echo "â±ï¸ [$(date +%T)] å½“å‰çŠ¶æ€: $CURRENT_STATUS (ç´¯è®¡ç­‰å¾… $(($(date +%s) - START_TIME)) ç§’)"

              if [ "$CURRENT_STATUS" == "RUNNING" ]; then
                echo "âœ… æœåŠ¡å·²æ­£å¼è¿è¡Œï¼"
                echo "ğŸ“Š å¯åŠ¨æ€»è€—æ—¶ï¼ˆå«æ’é˜Ÿï¼‰: $(($(date +%s) - START_TIME)) ç§’"
                exit 0
              fi
              
              if [ "$CURRENT_STATUS" == "CRASHED" ]; then
                echo "âŒ æœåŠ¡å¯åŠ¨å´©æºƒï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
                exit 1
              fi
            done
          fi
