name: Zeabur è‡ªåŠ¨åˆ·æ–°é‡å¯ (ç²¾ç®€ç‰ˆ)

on:
  schedule:
    - cron: '*/20 * * * *'  # æ¯ 20 åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-and-restart:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æµ‹ç½‘é¡µæ˜¯å¦å­˜æ´»
        id: check_status
        run: |
          TARGET="rww.zeabur.app"
          echo "ğŸ” æ­£åœ¨æ£€æµ‹ $TARGET ..."
          
          # è·å– HTTP çŠ¶æ€ç 
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" --connect-timeout 15 https://$TARGET)
          echo "ğŸ“¡ å½“å‰ HTTP çŠ¶æ€ç : $HTTP_STATUS"
          
          # åªè¦çŠ¶æ€ç æ˜¯ 200ï¼Œå°±æ ‡è®°ä¸ºéœ€è¦é‡å¯
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… ç½‘é¡µæ­£å¸¸ï¼Œæ‰§è¡Œé‡å¯ã€‚"
            echo "need_restart=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ç½‘é¡µä¸å¯è®¿é—®æˆ–é200çŠ¶æ€ï¼Œè·³è¿‡é‡å¯ã€‚"
            echo "need_restart=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œé‡å¯
        if: steps.check_status.outputs.need_restart == 'true'
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          echo "ğŸš€ æ­£åœ¨å‘ Zeabur å‘é€ restartService æŒ‡ä»¤..."
          
          QUERY="mutation { restartService(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          
          RESPONSE=$(curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')")
          
          echo "API å“åº”: $RESPONSE"
          
          if [[ $RESPONSE == *"restartService\":true"* ]]; then
            echo "ğŸ‰ é‡å¯æŒ‡ä»¤å·²ä¸‹è¾¾æˆåŠŸã€‚"
          else
            echo "âŒ é‡å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Secret é…ç½®ã€‚"
            exit 1
          fi
