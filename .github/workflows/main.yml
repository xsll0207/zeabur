name: Zeabur æ™ºèƒ½æ§åˆ¶ (v1.9.0)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡ŒåŠ¨ä½œ'
        required: true
        default: 'resume'
        type: choice
        options: [resume, suspend]

jobs:
  zeabur-task:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡ŒæŒ‡ä»¤å¹¶ç›‘æ§çŠ¶æ€
        env:
          ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
          ENVIRONMENT_ID: ${{ secrets.ENVIRONMENT_ID }}
        run: |
          ACTION="${{ github.event.inputs.action || 'suspend' }}"
          echo "ğŸš€ åŠ¨ä½œ: $ACTION"

          # 1. å‘é€æ§åˆ¶æŒ‡ä»¤
          QUERY="mutation { ${ACTION}Service(serviceID: \"$SERVICE_ID\", environmentID: \"$ENVIRONMENT_ID\") }"
          curl -s -X POST https://api.zeabur.com/graphql \
            -H "Authorization: Bearer $ZEABUR_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg q "$QUERY" '{"query": $q}')"

          # 2. å¦‚æœæ˜¯å¯åŠ¨åŠ¨ä½œï¼Œå¼€å§‹è®¡æ—¶ç›‘æ§
          if [ "$ACTION" == "resume" ]; then
            echo "â³ æ­£åœ¨ç›‘æµ‹æ’é˜Ÿä¸å¯åŠ¨æ—¶é—´..."
            START_TIME=$(date +%s)
            
            # å¾ªç¯æ£€æŸ¥çŠ¶æ€ï¼Œæœ€å¤šæŒç»­ 5 åˆ†é’Ÿ
            for i in {1..30}; do
              sleep 10
              
              # æŸ¥è¯¢æœ€æ–°çš„éƒ¨ç½²è®°å½•çŠ¶æ€
              STATUS_QUERY="query { service(_id: \"$SERVICE_ID\") { deployments(limit: 1) { edges { node { status } } } } }"
              STATUS_RES=$(curl -s -X POST https://api.zeabur.com/graphql \
                -H "Authorization: Bearer $ZEABUR_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg q "$STATUS_QUERY" '{"query": $q}')")
              
              CURRENT_STATUS=$(echo $STATUS_RES | jq -r '.data.service.deployments.edges[0].node.status')
              echo "â±ï¸ å½“å‰çŠ¶æ€: $CURRENT_STATUS (å·²è€—æ—¶ $(($(date +%s) - START_TIME)) ç§’)"

              if [ "$CURRENT_STATUS" == "RUNNING" ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
                echo "ğŸ“Š æœ¬æ¬¡å¯åŠ¨ï¼ˆå«æ’é˜Ÿï¼‰æ€»è€—æ—¶: $DURATION ç§’"
                exit 0
              fi
            done
            
            echo "âš ï¸ å¯åŠ¨è¶…æ—¶ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰ï¼Œè¯·æ£€æŸ¥ Zeabur æ§åˆ¶å°ã€‚"
          fi
